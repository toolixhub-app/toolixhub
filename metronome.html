<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metronome - ToolixHub</title>
    <link rel="stylesheet" href="css/style_v2.css">
    <style>
        /* --- ESTILOS ESPECﾃ孝ICOS DO METRﾃ年OMO (Unificados ao sistema) --- */
        .metronome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }
        
        .controls-top {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            background: #2a2a2a;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            color: var(--text-color);
        }
        
        select {
            padding: 5px;
            background: #333;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        #measure-display {
            color: var(--accent-color);
            font-weight: bold;
        }

        .bpm-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }

        /* CORREﾃﾃグ: Fonte maior e Bold como no original */
        #bpm-display { 
            font-size: 90px;
            font-weight: 900;
            color: var(--bpm-color, #c6ff00);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: -2px;
            min-width: 160px;
            text-align: center;
        }

        .bpm-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }

        #bpm-control {
            position: relative;
            width: 100%;
            height: 15px;
            background: #333;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        #bpm-dot {
            position: absolute;
            width: 25px;
            height: 25px;
            background-color: var(--accent-color);
            border-radius: 50%;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }

        .subdivision-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .sub-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sub-btn.active {
            background: var(--accent-color);
            color: #000;
            font-weight: bold;
        }

        .volume-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--secondary-text);
            margin-bottom: 10px;
        }

        .metronome-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-metro {
            background-color: var(--btn-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-metro#play-btn {
            background-color: var(--accent-color);
            color: #000;
        }

        /* CORREﾃﾃグ: Tempo decorrido */
        #timer-display {
            font-size: 16px;
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 10px;
            font-family: monospace;
        }

        #beat-indicator { 
            display: flex; 
            justify-content: center; 
            margin-top: 10px; 
            gap: 8px;
            min-height: 20px;
        }
        
        .beat-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #333;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .beat-dot.will-accent { border-color: #ff5252; }
        .beat-dot.accent-playing { background-color: #ff5252; }
        .beat-dot.normal-playing { background-color: var(--accent-color); }
        .beat-dot.sub-playing { background-color: #ff5252; opacity: 0.5; }

        .tool-info {
            background: var(--container-bg);
            padding: 15px;
            margin: 10px auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 420px;
            font-size: 14px;
            color: var(--secondary-text);
            text-align: left;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        .tool-info h3 { color: var(--accent-color); margin-top: 0; }
    </style>
</head>
<body>
    
    <div id="header-placeholder"></div>
    
    <div class="ad-space">Top Ad Banner (728x90)</div>
    
    <main class="calc-container" style="max-width: 450px;">
        <div class="metronome-container">
            
            <div class="controls-top">
                <label>Time Sig: 
                    <select id="time-signature">
                        <optgroup label="Simple" style="background:#2a2a2a; color:#fff">
                            <option value="2/4">2/4</option>
                            <option value="3/4">3/4</option>
                            <option value="4/4" selected>4/4</option>
                            <option value="5/4">5/4</option>
                            <option value="6/4">6/4</option>
                        </optgroup>
                        <optgroup label="Compound" style="background:#2a2a2a; color:#fff">
                            <option value="3/8">3/8</option>
                            <option value="6/8">6/8</option>
                            <option value="9/8">9/8</option>
                            <option value="12/8">12/8</option>
                        </optgroup>
                    </select>
                </label>
                <div>Measure: <span id="measure-display">1</span></div>
            </div>

            <div class="bpm-wrapper">
                <button class="bpm-btn" id="bpm-minus">-</button>
                <div id="bpm-display">120</div>
                <button class="bpm-btn" id="bpm-plus">+</button>
            </div>
            
            <div id="timer-display">00:00</div>

            <div id="bpm-control">
                <div id="bpm-dot"></div>
            </div>

            <div class="subdivision-container">
                <button class="sub-btn active" data-sub="1">1/4</button>
                <button class="sub-btn" data-sub="2">1/8</button>
                <button class="sub-btn" data-sub="3">1/8 T</button>
                <button class="sub-btn" data-sub="4">1/16</button>
            </div>
            
            <div class="volume-container">
                <span>這</span>
                <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.7">
                <span>矧</span>
            </div>

            <div class="metronome-controls">
                <button class="btn-metro" id="play-btn">Play</button>
                <button class="btn-metro" id="stop-btn">Stop</button>
                <button class="btn-metro" id="tap-btn">Tap</button>
            </div>

            <div id="beat-indicator"></div>
        </div>
    </main>

    <section class="tool-info">
        <h3>How to use</h3>
        <p><strong>Accent:</strong> Click the dots below the controls to set which beat is accented (red).</p>
        <p><strong>Speed:</strong> Use + / - buttons or drag the cyan dot on the slider.</p>
        <p><strong>Tap:</strong> Click "Tap" rhythmically to match your desired BPM.</p>
    </section>
    
    <div class="ad-space">Bottom Ad Banner (728x90)</div>

    <div id="footer-placeholder"></div>

    <script>
        function loadComponent(id, file) {
            fetch(file)
                .then(response => {
                    if (!response.ok) return '';
                    return response.text();
                })
                .then(data => {
                    document.getElementById(id).innerHTML = data;
                });
        }
        loadComponent('header-placeholder', 'header.html');
        loadComponent('footer-placeholder', 'footer.html');
    </script>
    
    <script>
        // --- Config & State ---
        let bpm = 120;
        let isPlaying = false;
        let currentBeat = 0;
        let currentMeasure = 1;
        let beatsPerMeasure = 4;
        let noteValue = 4;
        let subdivision = 1;
        let tempoAudioContext = null;
        let masterGainNode = null;
        let nextNoteTime = 0.0;
        let timerID = null;
        let accentBeatIndex = 0; 

        // CORREﾃﾃグ: Variﾃ｡veis do Timer
        let studyTimerID = null;
        let startTime = 0;

        const lookahead = 25.0;
        const scheduleAheadTime = 0.1;

        // --- UI Elements ---
        const bpmDisplay = document.getElementById('bpm-display');
        const bpmDot = document.getElementById('bpm-dot');
        const bpmControl = document.getElementById('bpm-control');
        const timeSigSelect = document.getElementById('time-signature');
        const beatIndicator = document.getElementById('beat-indicator');
        const measureDisplay = document.getElementById('measure-display');
        const volumeControl = document.getElementById('volume-control');
        const timerDisplay = document.getElementById('timer-display'); // CORREﾃﾃグ

        function init() {
            parseTimeSignature();
            renderBeats();
            updateBPMDisplay();
        }

        function parseTimeSignature() {
            const val = timeSigSelect.value;
            const parts = val.split('/');
            beatsPerMeasure = parseInt(parts[0]);
            noteValue = parseInt(parts[1]);
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            let timeToNext = secondsPerBeat / subdivision;
            if(noteValue === 8) timeToNext = (secondsPerBeat * 2) / subdivision;

            nextNoteTime += timeToNext;
            currentBeat = (currentBeat + 1) % (beatsPerMeasure * subdivision);
            if (currentBeat === 0) {
                currentMeasure++;
                measureDisplay.innerText = currentMeasure;
            }
        }

        function scheduleNote(beatNumber, time) {
            const isMainBeat = beatNumber % subdivision === 0;
            const mainBeatNumber = Math.floor(beatNumber / subdivision);
            const isAccent = mainBeatNumber === accentBeatIndex;

            setTimeout(() => {
                const dots = document.querySelectorAll('.beat-dot');
                dots.forEach((dot, index) => {
                    dot.classList.remove('normal-playing', 'accent-playing', 'sub-playing');
                    if (isMainBeat && index === mainBeatNumber) {
                        dot.classList.add(isAccent ? 'accent-playing' : 'normal-playing');
                    } else if (!isMainBeat && index === mainBeatNumber) {
                        dot.classList.add('sub-playing');
                    }
                });
            }, (time - tempoAudioContext.currentTime) * 1000);

            const osc = tempoAudioContext.createOscillator();
            const envelope = tempoAudioContext.createGain();

            if (isMainBeat) {
                osc.frequency.value = isAccent ? 1200 : 800;
                envelope.gain.setValueAtTime(1, time);
                envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            } else {
                osc.frequency.value = 600;
                envelope.gain.setValueAtTime(0.3, time);
                envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
            }

            osc.connect(envelope);
            envelope.connect(masterGainNode);
            masterGainNode.connect(tempoAudioContext.destination);
            osc.start(time);
            osc.stop(time + 0.05);
        }

        function scheduler() {
            while (nextNoteTime < tempoAudioContext.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeat, nextNoteTime);
                nextNote();
            }
            timerID = setTimeout(scheduler, lookahead);
        }

        function play() {
            if (!tempoAudioContext) {
                tempoAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGainNode = tempoAudioContext.createGain();
                masterGainNode.gain.value = volumeControl.value;
            }
            
            if (isPlaying) return;
            isPlaying = true;
            currentBeat = 0;
            currentMeasure = 1;
            measureDisplay.innerText = currentMeasure;
            nextNoteTime = tempoAudioContext.currentTime;

            // CORREﾃﾃグ: Iniciar Timer
            if (!studyTimerID) {
                startTime = Date.now();
                studyTimerID = setInterval(updateTimer, 1000);
            }
            
            scheduler();
            document.getElementById('play-btn').innerText = "Pause";
        }

        function pause() {
            isPlaying = false;
            clearTimeout(timerID);

            // CORREﾃﾃグ: Pausar Timer
            clearInterval(studyTimerID);
            studyTimerID = null;

            document.getElementById('play-btn').innerText = "Play";
        }

        function stop() {
            pause();
            currentBeat = 0;
            currentMeasure = 1;
            measureDisplay.innerText = currentMeasure;
            
            // CORREﾃﾃグ: Resetar Timer
            clearInterval(studyTimerID);
            studyTimerID = null;
            timerDisplay.innerText = "00:00";
            
            resetBeatVisuals();
        }

        // CORREﾃﾃグ: Funﾃｧﾃ｣o do Timer
        function updateTimer() {
            const diff = Date.now() - startTime;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            timerDisplay.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        volumeControl.addEventListener('input', (e) => {
            if (masterGainNode) masterGainNode.gain.value = e.target.value;
        });

        document.getElementById('play-btn').addEventListener('click', () => {
            if (isPlaying) pause(); else play();
        });
        document.getElementById('stop-btn').addEventListener('click', stop);

        function updateBPMDisplay() {
            bpmDisplay.innerText = bpm;
            const percentage = (bpm - 40) / (220 - 40);
            bpmDot.style.left = (percentage * 100) + "%";
        }

        function setBPMFromSlider(clientX) {
            const rect = bpmControl.getBoundingClientRect();
            let x = clientX - rect.left;
            x = Math.max(0, Math.min(rect.width, x));
            const percentage = x / rect.width;
            bpm = Math.round(40 + percentage * (220 - 40));
            updateBPMDisplay();
        }

        document.getElementById('bpm-plus').addEventListener('click', () => {
            if(bpm < 220) { bpm++; updateBPMDisplay(); }
        });
        document.getElementById('bpm-minus').addEventListener('click', () => {
            if(bpm > 40) { bpm--; updateBPMDisplay(); }
        });

        let dragging = false;
        bpmDot.addEventListener('mousedown', () => dragging = true);
        document.addEventListener('mouseup', () => dragging = false);
        document.addEventListener('mousemove', (e) => { if (dragging) setBPMFromSlider(e.clientX); });
        bpmControl.addEventListener('mousedown', (e) => setBPMFromSlider(e.clientX));

        // Touch
        bpmDot.addEventListener('touchstart', (e) => { dragging = true; e.preventDefault(); }, {passive: false});
        document.addEventListener('touchend', () => dragging = false);
        document.addEventListener('touchmove', (e) => { if (dragging) setBPMFromSlider(e.touches[0].clientX); e.preventDefault(); }, {passive: false});

        function renderBeats() {
            beatIndicator.innerHTML = '';
            if(accentBeatIndex >= beatsPerMeasure) accentBeatIndex = 0;
            for (let i = 0; i < beatsPerMeasure; i++) {
                const dot = document.createElement('div');
                dot.className = 'beat-dot';
                if(i === accentBeatIndex) dot.classList.add('will-accent');
                dot.addEventListener('click', () => {
                    accentBeatIndex = i;
                    updateAccentVisuals();
                });
                beatIndicator.appendChild(dot);
            }
        }

        function updateAccentVisuals() {
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach((dot, index) => {
                if(index === accentBeatIndex) dot.classList.add('will-accent');
                else dot.classList.remove('will-accent');
            });
        }

        function resetBeatVisuals() {
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach(dot => dot.classList.remove('normal-playing', 'accent-playing', 'sub-playing'));
        }

        timeSigSelect.addEventListener('change', () => {
            parseTimeSignature();
            currentBeat = 0;
            renderBeats();
        });

        document.querySelectorAll('.sub-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                subdivision = parseInt(e.target.dataset.sub);
            });
        });

        let tapTimes = [];
        document.getElementById('tap-btn').addEventListener('click', () => {
            const now = Date.now();
            tapTimes.push(now);
            if (tapTimes.length > 4) tapTimes.shift();
            if (tapTimes.length >= 2) {
                let intervals = [];
                for (let i = 1; i < tapTimes.length; i++) intervals.push(tapTimes[i] - tapTimes[i - 1]);
                let avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                bpm = Math.round(60000 / avg);
                updateBPMDisplay();
            }
        });

        init();
    </script>
</body>
</html>
