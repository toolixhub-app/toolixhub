<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metronome</title>
<style>
body {
  background-color: #1d1d1d;
  color: white;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px;
}

h1 {
  margin-bottom: 10px;
  font-size: 36px; /* Metronome Full menor */
}

.controls-top {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
}

/* Controle de BPM */
#bpm-display {
  font-size: 60px;
  margin: 20px 0;
}

#bpm-control {
  position: relative;
  width: 400px;
  height: 30px;
  margin-bottom: 30px;
  background: #333;
  border-radius: 15px;
}

#bpm-dot {
  position: absolute;
  width: 30px;
  height: 30px;
  background-color: red;
  border-radius: 50%;
  top: 0;
  left: 140px;
  cursor: pointer;
}

/* Botões */
.btn {
  background-color: #333;
  color: white;
  border: none;
  padding: 10px 18px;
  margin: 5px;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
}

/* Beat indicator */
#beat-indicator {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.beat-group {
  display: flex;
  margin: 0 10px;
}

.beat-dot {
  width: 20px;
  height: 20px;
  margin: 0 3px;
  border-radius: 50%;
  background-color: #555;
}

.separator {
  width: 4px;
  background-color: #888;
  margin: 0 6px;
}
</style>
</head>
<body>

<h1>Metronome</h1>

<div class="controls-top">
  <label for="time-signature">Time Sig: </label>
  <select id="time-signature">
    <option value="3">3/4</option>
    <option value="4" selected>4/4</option>
    <option value="6">6/8</option>
    <option value="7">7/8</option>
  </select>

  <label for="accent">Accent Beat: </label>
  <select id="accent">
    <option value="0">1</option>
    <option value="1">2</option>
    <option value="2">3</option>
    <option value="3">4</option>
    <option value="4">5</option>
    <option value="5">6</option>
    <option value="6">7</option>
  </select>
</div>

<div id="bpm-display">120</div>

<div id="bpm-control">
  <div id="bpm-dot"></div>
</div>

<div>
  <button class="btn" id="play-btn">Play</button>
  <button class="btn" id="pause-btn">Pause</button>
  <button class="btn" id="stop-btn">Stop</button>
  <button class="btn" id="tap-btn">Tap</button>
</div>

<div id="beat-indicator"></div>

<script>
let bpm = 120;
let intervalId;
let currentBeat = 0;
let ts = parseInt(document.getElementById('time-signature').value);
let accentBeat = parseInt(document.getElementById('accent').value);
let tapTimes = [];

const bpmDisplay = document.getElementById('bpm-display');
const bpmDot = document.getElementById('bpm-dot');
const bpmControl = document.getElementById('bpm-control');

function updateBPMDisplay() {
  bpmDisplay.innerText = bpm;
}

// Drag BPM dot
let dragging = false;
bpmDot.addEventListener('mousedown', () => dragging = true);
document.addEventListener('mouseup', () => dragging = false);
document.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  const rect = bpmControl.getBoundingClientRect();
  let x = e.clientX - rect.left;
  x = Math.max(0, Math.min(rect.width, x));
  bpm = Math.round(20 + (x / rect.width) * 300); // maior range
  bpmDot.style.left = (x - bpmDot.offsetWidth/2) + "px";
  updateBPMDisplay();
  if(intervalId) startMetronome();
});

// Beat indicator
const beatIndicator = document.getElementById('beat-indicator');
function renderBeats() {
  beatIndicator.innerHTML = '';
  if(ts === 6){
    for(let g=0; g<2; g++){
      const group = document.createElement('div');
      group.className = 'beat-group';
      for(let i=0;i<3;i++){
        const dot = document.createElement('div');
        dot.className='beat-dot';
        group.appendChild(dot);
      }
      beatIndicator.appendChild(group);
      if(g===0){
        const sep = document.createElement('div');
        sep.className='separator';
        beatIndicator.appendChild(sep);
      }
    }
  } else {
    const group = document.createElement('div');
    group.className='beat-group';
    for(let i=0;i<ts;i++){
      const dot = document.createElement('div');
      dot.className='beat-dot';
      group.appendChild(dot);
    }
    beatIndicator.appendChild(group);
  }
}
renderBeats();

document.getElementById('time-signature').addEventListener('change',(e)=>{
  ts = parseInt(e.target.value);
  currentBeat = 0;
  renderBeats();
});
document.getElementById('accent').addEventListener('change',(e)=>{
  accentBeat = parseInt(e.target.value);
});

// Metronome audio confiável
const clickNormal = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
const clickAccent = new Audio('https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg');

function startMetronome() {
  clearInterval(intervalId);
  const beatInterval = 60000 / bpm;
  intervalId = setInterval(() => {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach(dot=>dot.style.backgroundColor='#555');

    // som
    if(currentBeat === accentBeat){
      dots[currentBeat].style.backgroundColor='red';
      clickAccent.currentTime=0;
      clickAccent.play();
    } else {
      dots[currentBeat].style.backgroundColor='white';
      clickNormal.currentTime=0;
      clickNormal.play();
    }

    currentBeat = (currentBeat+1)%ts;
  }, beatInterval);
}

document.getElementById('play-btn').addEventListener('click', startMetronome);
document.getElementById('pause-btn').addEventListener('click', ()=>{
  clearInterval(intervalId);
});
document.getElementById('stop-btn').addEventListener('click', ()=>{
  clearInterval(intervalId);
  currentBeat=0;
  const dots = document.querySelectorAll('.beat-dot');
  dots.forEach(dot=>dot.style.backgroundColor='#555');
});

// Tap tempo
document.getElementById('tap-btn').addEventListener('click', ()=>{
  const now = Date.now();
  tapTimes.push(now);
  if(tapTimes.length>4) tapTimes.shift();
  if(tapTimes.length>=2){
    let intervals = [];
    for(let i=1;i<tapTimes.length;i++){
      intervals.push(tapTimes[i]-tapTimes[i-1]);
    }
    let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
    bpm = Math.round(60000/avg);
    updateBPMDisplay();
    const rect = bpmControl.getBoundingClientRect();
    let pos = ((bpm-20)/300)*rect.width;
    bpmDot.style.left = (pos - bpmDot.offsetWidth/2) + "px";
    if(intervalId) startMetronome();
  }
});
</script>

</body>
</html>
