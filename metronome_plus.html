import 'package:flutter/material.dart';
import 'package:audioplayers/audioplayers.dart';
import 'dart:async';

void main() => runApp(MetronomeApp());

class MetronomeApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: MetronomeFull(),
    );
  }
}

class MetronomeFull extends StatefulWidget {
  @override
  _MetronomeFullState createState() => _MetronomeFullState();
}

class _MetronomeFullState extends State<MetronomeFull> {
  int bpm = 120;
  int timeSig = 4;
  int currentBeat = 0;
  int accentIndex = 0;
  bool isPlaying = false;
  Timer? timer;

  AudioPlayer player = AudioPlayer();

  // Retorna as cores das bolinhas com base no beat atual e accent
  List<Color> getBeatColors() {
    return List.generate(timeSig, (index) {
      if (index == currentBeat) {
        return index == accentIndex ? Colors.red : Colors.white;
      } else {
        return Colors.grey.shade800;
      }
    });
  }

  void startMetronome() {
    if (isPlaying) return;
    isPlaying = true;
    int interval = (60000 / bpm).round();
    timer = Timer.periodic(Duration(milliseconds: interval), (t) {
      playClick();
      setState(() {
        currentBeat = (currentBeat + 1) % timeSig;
      });
    });
    setState(() {});
  }

  void stopMetronome() {
    timer?.cancel();
    timer = null;
    isPlaying = false;
    setState(() {
      currentBeat = 0;
    });
  }

  void pauseMetronome() {
    timer?.cancel();
    timer = null;
    isPlaying = false;
  }

  void playClick() async {
    String soundFile =
        currentBeat == accentIndex ? 'click_accent.wav' : 'click_normal.wav';
    await player.play(AssetSource(soundFile));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: Padding(
        padding: EdgeInsets.all(20),
        child: Column(
          children: [
            // TÃ­tulo e controles Time Sig + Accent
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  "Metronome Full",
                  style: TextStyle(
                      color: Colors.white,
                      fontSize: 28,
                      fontWeight: FontWeight.bold),
                ),
                Row(
                  children: [
                    Text("Time Sig:", style: TextStyle(color: Colors.white)),
                    SizedBox(width: 8),
                    DropdownButton<int>(
                      value: timeSig,
                      dropdownColor: Colors.grey.shade900,
                      style: TextStyle(color: Colors.white),
                      items: [2, 3, 4, 5, 6]
                          .map((e) => DropdownMenuItem(
                              value: e, child: Text("$e")))
                          .toList(),
                      onChanged: (val) {
                        setState(() {
                          timeSig = val!;
                          if (accentIndex >= timeSig) accentIndex = 0;
                        });
                      },
                    ),
                  ],
                )
              ],
            ),
            SizedBox(height: 20),

            // Controle de BPM
            Row(
              children: [
                Text("BPM", style: TextStyle(color: Colors.white, fontSize: 16)),
                Expanded(
                  child: Slider(
                    value: bpm.toDouble(),
                    min: 30,
                    max: 300,
                    activeColor: Colors.red,
                    inactiveColor: Colors.white24,
                    onChanged: (val) {
                      setState(() {
                        bpm = val.round();
                        if (isPlaying) {
                          stopMetronome();
                          startMetronome();
                        }
                      });
                    },
                  ),
                ),
                Text("$bpm",
                    style: TextStyle(color: Colors.white, fontSize: 24)),
              ],
            ),

            SizedBox(height: 20),

            // Bolinhas do beat (indicador)
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(timeSig, (index) {
                return GestureDetector(
                  onTap: () {
                    setState(() {
                      accentIndex = index;
                    });
                  },
                  child: Container(
                    margin: EdgeInsets.symmetric(horizontal: 8),
                    width: 30,
                    height: 30,
                    decoration: BoxDecoration(
                      color: index == accentIndex
                          ? Colors.red
                          : getBeatColors()[index],
                      shape: BoxShape.circle,
                    ),
                  ),
                );
              }),
            ),

            SizedBox(height: 40),

            // Controles Play / Pause / Stop / Tap
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                IconButton(
                  icon: Icon(Icons.play_arrow, color: Colors.white, size: 36),
                  onPressed: startMetronome,
                ),
                IconButton(
                  icon: Icon(Icons.pause, color: Colors.white, size: 36),
                  onPressed: pauseMetronome,
                ),
                IconButton(
                  icon: Icon(Icons.stop, color: Colors.white, size: 36),
                  onPressed: stopMetronome,
                ),
                IconButton(
                  icon: Icon(Icons.touch_app, color: Colors.white, size: 36),
                  onPressed: () {
                    setState(() {
                      bpm = (bpm + 1).clamp(30, 300);
                    });
                  },
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
