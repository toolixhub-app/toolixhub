<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Metronome 3.6</title>
<style>
body {
  background-color: #121212;
  color: #e0e0e0;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px;
  user-select: none;
  min-height: 100vh;
}

h1 { margin-bottom: 5px; font-size: 28px; color: #fff; }
.subtitle { color: #888; margin-bottom: 20px; font-size: 14px; }

.main-container {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  text-align: center;
  width: 100%;
  max-width: 450px;
  flex-grow: 1;
}

.controls-top {
  display: flex;
  justify-content: space-between;
  gap: 15px;
  margin-bottom: 15px;
  background: #2a2a2a;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  align-items: center;
}

select {
  padding: 5px;
  background: #333;
  color: white;
  border: 1px solid #555;
  border-radius: 4px;
  cursor: pointer;
  -webkit-appearance: none; /* Melhora renderizaÃ§Ã£o no Android */
}

#measure-display {
    font-size: 18px;
    color: #00bcd4;
    font-weight: bold;
}

/* BPM Display and Buttons */
.bpm-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 10px 0;
}

#bpm-display { font-size: 80px; font-weight: bold; color: #fff; min-width: 150px;}
.bpm-label { font-size: 16px; color: #888; margin-bottom: 5px; }

/* Timer Display */
#timer-display {
    font-size: 16px;
    color: #00bcd4;
    font-weight: bold;
    margin-bottom: 15px;
    font-family: monospace;
}

.bpm-btn {
    background: #333;
    border: none;
    color: white;
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.2s;
    touch-action: manipulation; /* Melhora resposta no mobile */
}
.bpm-btn:hover { background: #444; }

#bpm-control {
  position: relative;
  width: 100%;
  height: 15px;
  margin-bottom: 25px;
  background: #333;
  border-radius: 10px;
  cursor: pointer;
  touch-action: none; /* Importante para o slider mobile */
}

#bpm-dot {
  position: absolute;
  width: 25px;
  height: 25px;
  background-color: #00bcd4;
  border-radius: 50%;
  top: -5px;
  left: 140px;
  transform: translateX(-50%);
  cursor: pointer;
  box-shadow: 0 0 10px rgba(0,188,212,0.7);
  transition: left 0.05s linear;
}

/* Subdivision Controls */
.subdivision-container {
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
}

.sub-btn {
    background: #333;
    border: 1px solid #555;
    color: #aaa;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    touch-action: manipulation;
}

.sub-btn.active {
    background: #00bcd4;
    color: #000;
    border-color: #00bcd4;
    font-weight: bold;
}

/* Volume Control */
.volume-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 14px;
    color: #aaa;
}
input[type=range] { width: 150px; cursor: pointer; }

.btn-container { margin-bottom: 15px; }
.btn {
  background-color: #333;
  color: white;
  border: none;
  padding: 12px 24px;
  margin: 5px;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  font-size: 16px;
  transition: all 0.2s;
  min-width: 100px;
  touch-action: manipulation;
}
.btn:hover { background-color: #444; }
.btn:active { transform: translateY(1px); }
.btn#play-btn { background-color: #00bcd4; color: #000; }
.btn#play-btn:hover { background-color: #26c6da; }

/* Visual Dots Styles */
#beat-indicator { display: flex; justify-content: center; margin-top: 10px; min-height: 25px; flex-wrap: wrap; gap: 5px;}
.beat-dot {
  width: 15px;
  height: 15px;
  margin: 0 2px;
  border-radius: 50%;
  background-color: #333;
  transition: all 0.05s;
  cursor: pointer;
}
.beat-dot.active { background-color: #555; }
/* Destaque tempo normal */
.beat-dot.normal-playing { background-color: #00bcd4; box-shadow: 0 0 10px #00bcd4; transform: scale(1.2); }
/* Destaque acento (Vermelho) */
.beat-dot.accent-playing { background-color: #ff5252; box-shadow: 0 0 10px #ff5252; transform: scale(1.2); }
/* Destaque subdivisÃ£o */
.beat-dot.sub-playing { background-color: #ff5252; opacity: 0.7; transform: scale(0.8); }

.beat-dot.will-accent { border: 2px solid #ff5252; box-sizing: border-box; }

/* Footer */
footer {
    margin-top: 30px;
    font-size: 12px;
    color: #666;
    max-width: 600px;
    text-align: center;
    line-height: 1.5;
}

</style>
</head>
<body>

<h1>Metronome</h1>
<div class="subtitle">Pro 3.6</div>

<div class="main-container">
    <div class="controls-top">
      <label>T.S: 
        <select id="time-signature">
          <optgroup label="Simple" style="background:#333">
              <option value="2/4">2/4</option>
              <option value="3/4">3/4</option>
              <option value="4/4" selected>4/4</option>
              <option value="5/4">5/4</option>
              <option value="6/4">6/4</option>
              <option value="7/4">7/4</option>
          </optgroup>
          <optgroup label="Compound/Odd" style="background:#333">
              <option value="3/8">3/8</option>
              <option value="5/8">5/8</option>
              <option value="6/8">6/8</option>
              <option value="7/8">7/8</option>
              <option value="9/8">9/8</option>
              <option value="11/8">11/8</option>
              <option value="12/8">12/8</option>
              <option value="13/8">13/8</option>
          </optgroup>
        </select>
      </label>
      <div>Comp: <span id="measure-display">1</span></div>
    </div>

    <div class="bpm-wrapper">
        <button class="bpm-btn" id="bpm-minus">-</button>
        <div id="bpm-display">120</div>
        <button class="bpm-btn" id="bpm-plus">+</button>
    </div>
    <div class="bpm-label">BPM</div>
    
    <div id="timer-display">00:00</div>

    <div id="bpm-control">
      <div id="bpm-dot"></div>
    </div>

    <div class="subdivision-container">
        <button class="sub-btn active" data-sub="1">1/4</button>
        <button class="sub-btn" data-sub="2">1/8</button>
        <button class="sub-btn" data-sub="3">1/8 T</button>
        <button class="sub-btn" data-sub="4">1/16</button>
    </div>
    
    <div class="volume-container">
        <span>ðŸ”‡</span>
        <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.7">
        <span>ðŸ”Š</span>
    </div>

    <div class="btn-container">
      <button class="btn" id="play-btn">Play</button>
      <button class="btn" id="stop-btn">Stop</button>
      <button class="btn" id="tap-btn">Tap</button>
    </div>

    <div id="beat-indicator"></div>
</div>

<footer>
    Pro Metronome v3.6. A precise tool for musicians to practice timing and subdivision. Featuring audio-synced visual cues, multiple time signatures, and a built-in study timer.
</footer>

<script>
// --- Config & State ---
let bpm = 120;
let isPlaying = false;
let currentBeat = 0;
let currentMeasure = 1;
let beatsPerMeasure = 4;
let noteValue = 4;
let subdivision = 1;
let tempoAudioContext = null;
let masterGainNode = null;
let nextNoteTime = 0.0;
let timerID = null;
let accentBeatIndex = 0; 

// Timer
let studyTimerID = null;
let startTime = 0;

const lookahead = 25.0;
const scheduleAheadTime = 0.1;

// --- UI Elements ---
const bpmDisplay = document.getElementById('bpm-display');
const bpmDot = document.getElementById('bpm-dot');
const bpmControl = document.getElementById('bpm-control');
const timeSigSelect = document.getElementById('time-signature');
const beatIndicator = document.getElementById('beat-indicator');
const measureDisplay = document.getElementById('measure-display');
const volumeControl = document.getElementById('volume-control');
const timerDisplay = document.getElementById('timer-display');

// --- Initialization ---
function init() {
  parseTimeSignature();
  renderBeats();
  updateBPMDisplay();
}

// --- Parse Time Sig ---
function parseTimeSignature() {
    const val = timeSigSelect.value;
    const parts = val.split('/');
    beatsPerMeasure = parseInt(parts[0]);
    noteValue = parseInt(parts[1]);
}

// --- Audio Logic ---
function nextNote() {
  const secondsPerBeat = 60.0 / bpm;
  let timeToNext = secondsPerBeat / subdivision;
  if(noteValue === 8) timeToNext = (secondsPerBeat * 2) / subdivision;

  nextNoteTime += timeToNext;
  
  currentBeat = (currentBeat + 1) % (beatsPerMeasure * subdivision);
  if (currentBeat === 0) {
      currentMeasure++;
      measureDisplay.innerText = currentMeasure;
  }
}

function scheduleNote(beatNumber, time) {
  const isMainBeat = beatNumber % subdivision === 0;
  const mainBeatNumber = Math.floor(beatNumber / subdivision);
  const isAccent = mainBeatNumber === accentBeatIndex;

  // Visual Update
  setTimeout(() => {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach((dot, index) => {
      dot.classList.remove('normal-playing', 'accent-playing', 'sub-playing');
      
      if (isMainBeat && index === mainBeatNumber) {
          dot.classList.add(isAccent ? 'accent-playing' : 'normal-playing');
      } else if (!isMainBeat && index === mainBeatNumber) {
          dot.classList.add('sub-playing');
      }
    });
  }, (time - tempoAudioContext.currentTime) * 1000);

  // Sound
  const osc = tempoAudioContext.createOscillator();
  const envelope = tempoAudioContext.createGain();

  if (isMainBeat) {
      osc.frequency.value = isAccent ? 1200 : 800;
      envelope.gain.setValueAtTime(1, time);
      envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
  } else {
      osc.frequency.value = 600;
      envelope.gain.setValueAtTime(0.3, time);
      envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
  }

  osc.connect(envelope);
  envelope.connect(masterGainNode);
  masterGainNode.connect(tempoAudioContext.destination);
  osc.start(time);
  osc.stop(time + 0.05);
}

function scheduler() {
  while (nextNoteTime < tempoAudioContext.currentTime + scheduleAheadTime) {
    scheduleNote(currentBeat, nextNoteTime);
    nextNote();
  }
  timerID = setTimeout(scheduler, lookahead);
}

// --- Transport ---
function play() {
  if (!tempoAudioContext) {
    tempoAudioContext = new (window.AudioContext || window.webkitAudioContext)();
    masterGainNode = tempoAudioContext.createGain();
    masterGainNode.gain.value = volumeControl.value;
  }
  
  if (isPlaying) return;
  isPlaying = true;
  currentBeat = 0;
  currentMeasure = 1;
  measureDisplay.innerText = currentMeasure;
  nextNoteTime = tempoAudioContext.currentTime;
  
  // Timer
  if (!studyTimerID) {
    startTime = Date.now();
    studyTimerID = setInterval(updateTimer, 1000);
  }
  
  scheduler();
  document.getElementById('play-btn').innerText = "Pause";
}

function pause() {
  isPlaying = false;
  clearTimeout(timerID);
  
  // Pause timer
  clearInterval(studyTimerID);
  studyTimerID = null;
  
  document.getElementById('play-btn').innerText = "Play";
}

function stop() {
  pause();
  currentBeat = 0;
  currentMeasure = 1;
  measureDisplay.innerText = currentMeasure;
  
  // Reset timer
  clearInterval(studyTimerID);
  studyTimerID = null;
  timerDisplay.innerText = "00:00";
  
  resetBeatVisuals();
}

// --- Helpers (Timer & Volume) ---
function updateTimer() {
  const diff = Date.now() - startTime;
  const minutes = Math.floor(diff / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);
  timerDisplay.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

volumeControl.addEventListener('input', (e) => {
    if (masterGainNode) {
        masterGainNode.gain.value = e.target.value;
    }
});

document.getElementById('play-btn').addEventListener('click', () => {
  if (isPlaying) pause(); else play();
});
document.getElementById('stop-btn').addEventListener('click', stop);

// --- UI Funcs ---
function updateBPMDisplay() {
  bpmDisplay.innerText = bpm;
  const percentage = (bpm - 40) / (220 - 40);
  bpmDot.style.left = (percentage * 100) + "%";
}

function setBPMFromSlider(clientX) {
  const rect = bpmControl.getBoundingClientRect();
  let x = clientX - rect.left;
  x = Math.max(0, Math.min(rect.width, x));
  const percentage = x / rect.width;
  bpm = Math.round(40 + percentage * (220 - 40));
  updateBPMDisplay();
}

// Buttons
document.getElementById('bpm-plus').addEventListener('click', () => {
    if(bpm < 220) { bpm++; updateBPMDisplay(); }
});
document.getElementById('bpm-minus').addEventListener('click', () => {
    if(bpm > 40) { bpm--; updateBPMDisplay(); }
});

// --- Slider Touch/Mouse Events ---
let dragging = false;

// Mouse
bpmDot.addEventListener('mousedown', () => dragging = true);
document.addEventListener('mouseup', () => dragging = false);
document.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  setBPMFromSlider(e.clientX);
});
bpmControl.addEventListener('mousedown', (e) => setBPMFromSlider(e.clientX));

// Touch (Android/iOS)
bpmDot.addEventListener('touchstart', (e) => {
    dragging = true;
    e.preventDefault();
}, {passive: false});

document.addEventListener('touchend', () => dragging = false);
document.addEventListener('touchmove', (e) => {
  if (!dragging) return;
  setBPMFromSlider(e.touches[0].clientX);
  e.preventDefault();
}, {passive: false});

bpmControl.addEventListener('touchstart', (e) => {
    setBPMFromSlider(e.touches[0].clientX);
    dragging = true;
    e.preventDefault();
}, {passive: false});

// --- Time Signature & Accent ---
function renderBeats() {
  beatIndicator.innerHTML = '';
  if(accentBeatIndex >= beatsPerMeasure) accentBeatIndex = 0;

  for (let i = 0; i < beatsPerMeasure; i++) {
    const dot = document.createElement('div');
    dot.className = 'beat-dot';
    
    if(i === accentBeatIndex) {
        dot.classList.add('will-accent');
    }

    dot.addEventListener('click', () => {
        accentBeatIndex = i;
        updateAccentVisuals();
    });

    beatIndicator.appendChild(dot);
  }
}

function updateAccentVisuals() {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach((dot, index) => {
        if(index === accentBeatIndex) {
            dot.classList.add('will-accent');
        } else {
            dot.classList.remove('will-accent');
        }
    });
}

function resetBeatVisuals() {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach(dot => {
        dot.classList.remove('normal-playing', 'accent-playing', 'sub-playing');
    });
}

timeSigSelect.addEventListener('change', (e) => {
  parseTimeSignature();
  currentBeat = 0;
  renderBeats();
});

// --- Subdivision ---
document.querySelectorAll('.sub-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        subdivision = parseInt(e.target.dataset.sub);
    });
});

// Tap Tempo
let tapTimes = [];
document.getElementById('tap-btn').addEventListener('click', () => {
  const now = Date.now();
  tapTimes.push(now);
  if (tapTimes.length > 4) tapTimes.shift();
  if (tapTimes.length >= 2) {
    let intervals = [];
    for (let i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    let avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    bpm = Math.round(60000 / avg);
    updateBPMDisplay();
  }
});

init();
</script>
</body>
</html>
