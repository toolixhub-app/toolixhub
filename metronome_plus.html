<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metronome Pro</title>
<style>
body {
  background-color: #1d1d1d;
  color: white;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px;
}

h1 { margin-bottom: 10px; font-size: 32px; }

.controls-top {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
  background: #2a2a2a;
  padding: 10px 20px;
  border-radius: 8px;
}

select {
  padding: 5px;
  background: #333;
  color: white;
  border: 1px solid #555;
  border-radius: 4px;
}

#bpm-display { font-size: 72px; font-weight: bold; margin: 10px 0; color: #00bcd4; }

#bpm-control {
  position: relative;
  width: 400px;
  height: 15px;
  margin-bottom: 30px;
  background: #333;
  border-radius: 10px;
  cursor: pointer;
}

#bpm-dot {
  position: absolute;
  width: 25px;
  height: 25px;
  background-color: #00bcd4;
  border-radius: 50%;
  top: -5px;
  left: 140px;
  transform: translateX(-50%);
  cursor: pointer;
  box-shadow: 0 0 10px rgba(0,188,212,0.5);
}

.btn {
  background-color: #333;
  color: white;
  border: none;
  padding: 12px 24px;
  margin: 5px;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  font-size: 16px;
  transition: background 0.2s;
}
.btn:hover { background-color: #444; }
.btn:active { background-color: #555; }
.btn#play-btn { background-color: #2e7d32; }
.btn#play-btn:hover { background-color: #388e3c; }

#beat-indicator { display: flex; justify-content: center; margin-top: 30px; }
.beat-dot {
  width: 20px;
  height: 20px;
  margin: 0 5px;
  border-radius: 50%;
  background-color: #444;
  transition: background-color 0.1s;
}
.beat-dot.active { background-color: #00bcd4; box-shadow: 0 0 10px #00bcd4; }
.beat-dot.accent { background-color: #ff5252; box-shadow: 0 0 10px #ff5252; }
</style>
</head>
<body>

<h1>Metronome</h1>

<div class="controls-top">
  <label>Time Sig: 
    <select id="time-signature">
      <option value="3">3/4</option>
      <option value="4" selected>4/4</option>
      <option value="5">5/4</option>
      <option value="6">6/8</option>
    </select>
  </label>
</div>

<div id="bpm-display">120</div>

<div id="bpm-control">
  <div id="bpm-dot"></div>
</div>

<div>
  <button class="btn" id="play-btn">Play</button>
  <button class="btn" id="stop-btn">Stop</button>
  <button class="btn" id="tap-btn">Tap</button>
</div>

<div id="beat-indicator"></div>

<script>
// --- Configurações e Estado ---
let bpm = 120;
let isPlaying = false;
let currentBeat = 0;
let timeSignature = 4;
let tempoAudioContext = null;
let nextNoteTime = 0.0;
let timerID = null;

// Parâmetros de agendamento (em segundos)
const lookahead = 25.0; // Frequência de verificação da fila
const scheduleAheadTime = 0.1; // Quanto tempo à frente agendar

// --- UI Elements ---
const bpmDisplay = document.getElementById('bpm-display');
const bpmDot = document.getElementById('bpm-dot');
const bpmControl = document.getElementById('bpm-control');
const timeSigSelect = document.getElementById('time-signature');
const beatIndicator = document.getElementById('beat-indicator');

// --- Inicialização ---
function init() {
  renderBeats();
  updateBPMDisplay();
}

// --- Lógica de Áudio (Precisão) ---
function nextNote() {
  const secondsPerBeat = 60.0 / bpm;
  nextNoteTime += secondsPerBeat;
  currentBeat = (currentBeat + 1) % timeSignature;
}

function scheduleNote(beatNumber, time) {
  // Visualização
  setTimeout(() => {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach((dot, index) => {
      dot.className = 'beat-dot'; // reset
      if (index === beatNumber) {
        dot.classList.add(beatNumber === 0 ? 'accent' : 'active');
      }
    });
  }, (time - tempoAudioContext.currentTime) * 1000);

  // Som
  const osc = tempoAudioContext.createOscillator();
  const envelope = tempoAudioContext.createGain();

  // Frequência do som (mais agudo no primeiro tempo)
  osc.frequency.value = (beatNumber === 0) ? 1000 : 800;
  envelope.gain.value = 1;
  envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.1);

  osc.connect(envelope);
  envelope.connect(tempoAudioContext.destination);

  osc.start(time);
  osc.stop(time + 0.1);
}

function scheduler() {
  while (nextNoteTime < tempoAudioContext.currentTime + scheduleAheadTime) {
    scheduleNote(currentBeat, nextNoteTime);
    nextNote();
  }
  timerID = setTimeout(scheduler, lookahead);
}

// --- Controle de Transporte ---
function play() {
  if (!tempoAudioContext) {
    tempoAudioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  if (isPlaying) return;
  isPlaying = true;
  currentBeat = 0;
  nextNoteTime = tempoAudioContext.currentTime;
  scheduler();
  document.getElementById('play-btn').innerText = "Pause";
}

function pause() {
  isPlaying = false;
  clearTimeout(timerID);
  document.getElementById('play-btn').innerText = "Play";
}

function stop() {
  pause();
  currentBeat = 0;
  resetBeatVisuals();
}

document.getElementById('play-btn').addEventListener('click', () => {
  if (isPlaying) pause(); else play();
});
document.getElementById('stop-btn').addEventListener('click', stop);

// --- Funcionalidades UI ---
function updateBPMDisplay() {
  bpmDisplay.innerText = bpm;
  // Atualiza posição do dot
  const percentage = (bpm - 40) / (220 - 40);
  bpmDot.style.left = (percentage * 100) + "%";
}

function setBPMFromSlider(e) {
  const rect = bpmControl.getBoundingClientRect();
  let x = e.clientX - rect.left;
  x = Math.max(0, Math.min(rect.width, x));
  const percentage = x / rect.width;
  bpm = Math.round(40 + percentage * (220 - 40));
  updateBPMDisplay();
}

// Dragging slider
let dragging = false;
bpmDot.addEventListener('mousedown', () => dragging = true);
document.addEventListener('mouseup', () => dragging = false);
document.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  setBPMFromSlider(e);
});
bpmControl.addEventListener('mousedown', setBPMFromSlider);

// Time Signature
function renderBeats() {
  beatIndicator.innerHTML = '';
  for (let i = 0; i < timeSignature; i++) {
    const dot = document.createElement('div');
    dot.className = 'beat-dot';
    beatIndicator.appendChild(dot);
  }
}

function resetBeatVisuals() {
    const dots = document.querySelectorAll('.beat-dot');
    dots.forEach(dot => dot.className = 'beat-dot');
}

timeSigSelect.addEventListener('change', (e) => {
  timeSignature = parseInt(e.target.value);
  currentBeat = 0;
  renderBeats();
});

// Tap Tempo
let tapTimes = [];
document.getElementById('tap-btn').addEventListener('click', () => {
  const now = Date.now();
  tapTimes.push(now);
  if (tapTimes.length > 4) tapTimes.shift();
  if (tapTimes.length >= 2) {
    let intervals = [];
    for (let i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    let avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    bpm = Math.round(60000 / avg);
    updateBPMDisplay();
  }
});

init();
</script>
</body>
</html>
